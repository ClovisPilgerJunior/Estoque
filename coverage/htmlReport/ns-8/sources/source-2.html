


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ProdutoCapaService</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.janfer.estoque.services</a>
</div>

<h1>Coverage Summary for Class: ProdutoCapaService (com.janfer.estoque.services)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ProdutoCapaService</td>
<td class="coverageStat">
  <span class="percent">
    11,1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    2%
  </span>
  <span class="absValue">
    (1/51)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ProdutoCapaService$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    11,1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    2%
  </span>
  <span class="absValue">
    (1/51)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.janfer.estoque.services;
&nbsp;
&nbsp;import com.janfer.estoque.domain.entities.ProdutoCapa;
&nbsp;import com.janfer.estoque.domain.entities.dtos.ProdutoCapaGetDTO;
&nbsp;import com.janfer.estoque.domain.entities.enums.Resuprimento;
&nbsp;import com.janfer.estoque.domain.entities.mappers.MapStructMapper;
&nbsp;import com.janfer.estoque.repositories.*;
&nbsp;import com.janfer.estoque.services.exceptions.DataIntegrityViolationException;
&nbsp;import com.janfer.estoque.services.exceptions.ObjectNotFoundException;
&nbsp;import jakarta.transaction.Transactional;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Optional;
&nbsp;
&nbsp;@Service
<b class="fc">&nbsp;public class ProdutoCapaService {</b>
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoCapaRepository produtoCapaRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoEntradaRepository produtoEntradaRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoSaidaRepository produtoSaidaRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoPerdaRepository produtoPerdaRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  FornecedorRepository fornecedorRepository;
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoEntradaService produtoEntradaService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoPerdaService produtoPerdaService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  ProdutoSaidaService produtoSaidaService;
&nbsp;
&nbsp;  @Autowired
&nbsp;  MapStructMapper mapStructMapper;
&nbsp;
&nbsp;
&nbsp;  @Transactional
&nbsp;  public List&lt;ProdutoCapa&gt; findAll() {
<b class="nc">&nbsp;    return produtoCapaRepository.findAllAtivos();</b>
&nbsp;  }
&nbsp;
&nbsp;  @Transactional
&nbsp;  public ProdutoCapa save(ProdutoCapa produtoCapa) {
&nbsp;
<b class="nc">&nbsp;    if(produtoCapaRepository.existsByDescAndIdNot(produtoCapa.getDesc(), produtoCapa.getId())){</b>
<b class="nc">&nbsp;      throw new DataIntegrityViolationException(&quot;Produto já cadastrado&quot;);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if (produtoCapa.getFornecedor() != null &amp;&amp; produtoCapa.getFornecedor().getId() != null) {</b>
<b class="nc">&nbsp;      Long fornecedorId = produtoCapa.getFornecedor().getId();</b>
<b class="nc">&nbsp;      if (!fornecedorRepository.existsById(fornecedorId)) {</b>
<b class="nc">&nbsp;        throw new ObjectNotFoundException(&quot;Fornecedor não encontrado&quot;);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    if(produtoCapa.getResuprimento() == null){</b>
<b class="nc">&nbsp;      produtoCapa.setResuprimento(Resuprimento.SALDO_ZERADO);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    produtoCapa = produtoCapaRepository.save(produtoCapa);</b>
&nbsp;
<b class="nc">&nbsp;    Long produtoCapaId = produtoCapa.getId();</b>
<b class="nc">&nbsp;    if (!produtoCapaRepository.isProdutoAtivoById(produtoCapaId)) {</b>
<b class="nc">&nbsp;      produtoCapa.setAtivo(false);</b>
<b class="nc">&nbsp;      produtoCapaRepository.save(produtoCapa);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    return produtoCapa;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Transactional
&nbsp;  public void delete(ProdutoCapa produtoCapa) {
<b class="nc">&nbsp;    if (produtoEntradaRepository.existsById(produtoCapa.getId())) {</b>
<b class="nc">&nbsp;      throw new DataIntegrityViolationException(&quot;Não é possível excluir um produto com entrada existente&quot;);</b>
&nbsp;    }
<b class="nc">&nbsp;    produtoCapaRepository.delete(produtoCapa);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Transactional
&nbsp;  public Optional&lt;ProdutoCapa&gt; findById(Long id) {
<b class="nc">&nbsp;    return produtoCapaRepository.findById(id);</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean existById(Long id) {
<b class="nc">&nbsp;    return produtoCapaRepository.existsById(id);</b>
&nbsp;  }
&nbsp;
&nbsp;  public boolean isProdutoAtivoById(Long id) {
<b class="nc">&nbsp;    return produtoCapaRepository.isProdutoAtivoById(id);</b>
&nbsp;  }
&nbsp;
&nbsp;  public List&lt;ProdutoCapaGetDTO&gt; obterProdutoCapaComCalculos(List&lt;ProdutoCapa&gt; produtoCapas) {
<b class="nc">&nbsp;    List&lt;ProdutoCapaGetDTO&gt; produtoCapaGetDTOs = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;    for (ProdutoCapa produtoCapa : produtoCapas) {</b>
<b class="nc">&nbsp;      ProdutoCapaGetDTO produtoCapaGetDTO = mapStructMapper.produtoCapaToProdutoCapaGetDTO(produtoCapa);</b>
&nbsp;
&nbsp;      // Calculo de produtoEntrada
&nbsp;
<b class="nc">&nbsp;      Double somaEntradas = produtoEntradaService.calcularSomaEntradas(produtoCapa.getId());</b>
<b class="nc">&nbsp;      Double ultimoPrecoCompra = produtoEntradaService.recuperarUltimoPrecoCompra(produtoCapa.getId());</b>
&nbsp;
&nbsp;      // Calculo de produtoPerda
<b class="nc">&nbsp;      Double somaPerdas = produtoPerdaService.calcularSomaPerdas(produtoCapa.getId());</b>
&nbsp;
&nbsp;      // Calculo do ProdutoSaida
<b class="nc">&nbsp;      Double somaSaida = produtoSaidaService.calcularSomaSaida(produtoCapa.getId());</b>
&nbsp;
&nbsp;
<b class="nc">&nbsp;      produtoCapaGetDTO.setEntradas(somaEntradas != null ? somaEntradas : 0.0);</b>
<b class="nc">&nbsp;      produtoCapaGetDTO.setValorCompra(ultimoPrecoCompra != null ? ultimoPrecoCompra : 0.0);</b>
<b class="nc">&nbsp;      produtoCapaGetDTO.setPerdas(somaPerdas != null ? somaPerdas : 0.0);</b>
<b class="nc">&nbsp;      produtoCapaGetDTO.setSaidas(somaSaida != null ? somaSaida : 0.0);</b>
<b class="nc">&nbsp;      double saldo = ((somaEntradas != null ? somaEntradas : 0.0) - (somaPerdas != null ? somaPerdas : 0.0) - (somaSaida != null ? somaSaida : 0.0));</b>
&nbsp;
<b class="nc">&nbsp;      double totalGeral = (saldo * (ultimoPrecoCompra != null ? ultimoPrecoCompra : 0.0));</b>
&nbsp;
<b class="nc">&nbsp;      produtoCapaGetDTO.setSaldo(saldo);</b>
<b class="nc">&nbsp;      produtoCapaGetDTO.setValorTotal(totalGeral);</b>
&nbsp;
<b class="nc">&nbsp;      Resuprimento resuprimento = calcularResuprimento(produtoCapaGetDTO.getSaldo(), produtoCapaGetDTO.getMinimo(), produtoCapaGetDTO.getMaximo());</b>
<b class="nc">&nbsp;      produtoCapaGetDTO.setResuprimento(resuprimento);</b>
&nbsp;
<b class="nc">&nbsp;      produtoCapaGetDTOs.add(produtoCapaGetDTO);</b>
<b class="nc">&nbsp;    }</b>
&nbsp;
<b class="nc">&nbsp;    return produtoCapaGetDTOs;</b>
&nbsp;  }
&nbsp;
&nbsp;  public Resuprimento calcularResuprimento(Double saldo, Long minimo, Long maximo) {
<b class="nc">&nbsp;    if (saldo &lt; 0) {</b>
<b class="nc">&nbsp;      return Resuprimento.ESTOQUE_NEGATIVO;</b>
<b class="nc">&nbsp;    } else if (saldo == 0) {</b>
<b class="nc">&nbsp;      return Resuprimento.SALDO_ZERADO;</b>
<b class="nc">&nbsp;    } else if (saldo &gt; maximo) {</b>
<b class="nc">&nbsp;      return Resuprimento.PRODUTO_EXCESSO;</b>
<b class="nc">&nbsp;    } else if (saldo &gt;= minimo &amp;&amp; saldo &lt;= maximo) {</b>
<b class="nc">&nbsp;      return Resuprimento.QUANTIDADE_IDEAL;</b>
&nbsp;    } else {
<b class="nc">&nbsp;      return Resuprimento.COMPRAR_AGORA;</b>
&nbsp;    }
&nbsp;
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-10-05 10:41</div>
</div>
</body>
</html>
